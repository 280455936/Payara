<!DOCTYPE html>
<html>
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.css" rel="stylesheet" type="text/css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js"></script>

    <style>
    .canvas-holder {
	    background-color: #FFFFFF;
	    position: absolute;
	    top: 200px;
	    left: 20px;
	    width: 600px;
	    border: 2px solid #ccc;
    }
    body { margin: 2em; }
    </style>
</head>
<body>

<h1>Monitoring Console (Alpha)</h1>

<input type="checkbox" id="zero" checked="checked" /> Begin at Zero</br>
<input type="checkbox" id="labels" checked="checked" /> Automatic Labels</br>
Series: <select id="options"></select>
<div class="canvas-holder">
    <canvas id="myChart" width="2" height="1"></canvas>
</div>

<script>
var lastNs;
var options = $("#options");
$.getJSON("api/points/series/", function(response) {
    $.each(response, function() {
    	var key = this.replace(/ /g, ',');
        var ns =  this.substring(3, this.indexOf(' '));
        var $option = $("<option />").val(key).text(this.substring(this.indexOf(' ')));
        if (ns == lastNs) {
        	options.find('optgroup').last().append($option);
        } else {
        	var group = $('<optgroup/>').attr('label', ns);
        	group.append($option);
        	options.append(group);
        }
        lastNs = ns;
    });
});


var refresher;
var chart;

$("#zero").on('change', function() {
	if (chart) {
		chart.options.scales.yAxes[0].ticks.beginAtZero = this.checked;
		chart.update();
	}
});

$("#labels").on('change', function() {
    if (chart) {
        chart.options.scales.xAxes[0].ticks.source = this.checked ? 'auto' : 'data';
        chart.update();
    }
});

options.on('change', function() {
	var selectedSeries = this.value;
	var label = this.textContent;
	if (refresher) {
		clearInterval(refresher);
	}
    var ctx = $('#myChart');
    if (chart) {
    	chart.destroy();
    }
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [{ 
            	label: 'line 1', 
            	data: [],
                backgroundColor: [
                    'rgba(153, 102, 255, 0.2)',
                ],
                borderColor: [
                    'rgba(153, 102, 255, 1)',
                ],
                borderWidth: 1
            }],
        },
        options: {
            scales: {
                xAxes: [{
                    type: 'time',
                    time: {
                        unit: 'second'
                    }
                }],
                yAxes: [{
                    display: true,
                    ticks: {
                        beginAtZero: $('#zero')[0].checked,
                        precision:0, // no decimal places in labels
                    },
                }],
            }
        }
    });
	
	refresher = setInterval(updateSeries, 1000, selectedSeries);
});

function updateSeries(series) {
	$.getJSON('api/points/series/' + series, function(data) {
		if (data) {
		    for (var i = 0; i < data.length; i++) {
		        data[i].t = new Date(data[i].time);
		        data[i].y = data[i].value;
		    }
		}
	    chart.data.datasets[0].data = data;
	    chart.data.datasets[0].label = series;
	    chart.update(0);
	});
} 
</script>

</body>
</html>
